---
layout: post
title: '[Elasticsearch] 노드 제외되었을 때 샤드할당 지연시키기'
subtitle: '샤드 할당을 지연 시키는 것이 유리한 경우'
author: 'sunyoung.dev'
date: 2021-10-07
header-img: img/in-post/delay.jpg
lang: ko
catalog: true
tags:
  - 엘라스틱서치
---

다음은 [https://www.elastic.co/guide/en/elasticsearch/reference/current/delayed-allocation.html](https://www.elastic.co/guide/en/elasticsearch/reference/current/delayed-allocation.html) 문서를 번역한 내용입니다.

어떤 이유이던간에, 노드가 클러스터에서 제외되면 마스터는 다음과 같은 반응을 보인다.

- 제외된 노드의 프라이머리 샤드에 대한 레플리카 샤드를 프라이머리 샤드로 승격시킨다
- (프라이머리 샤드가 되어) 사라진 레플리카 샤드를 대체할 레플리카 샤드를 할당한다
- 남아있는 노드들에 샤드가 균등하게 분포하도록 리밸런싱 작업을 한다

이 작업은 가능한 빠르게 모든 샤드가 레플리카 샤드를 가지도록 함으로써 데이터 유실을 방지하기 위해 실행된다.

노드 레벨과 클러스터 레벨에서 모두 동시에 실행되는 복제에 대해 throttle 설정이 있긴 하지만, 이 “shard-shuffle” 작업은 클러스터에 여전히 큰 추가적인 부담을 준다. 만약 제외된 노드가 곧 돌아올 상황에서는 필요하지 않은 작업이다. 다음 시나리오를 생각해보자.

- 노드 5번의 네트워크 연결이 끊김
- 마스터가 노드 5번이 가지고 있던 프라이머리 샤드에 대해 모든 레플리카 샤드를 프라이머리 샤드로 승격시킴
- 마스터가 새로운 레플리카 샤드를 다른 노드에 할당함
- 새로운 레플리카 샤드는 네트워크를 통해서 프라이머리 샤드에 대한 전체 복사본을 생성함
- 클러스터 리밸런싱 작업으로 더 많은 샤드가 다른 노드로 이동
- 노드 5번이 얼마 지나지 않아 클러스터에 포함됨
- 노드 5번에 샤드를 할당함으로써 클러스터 리밸런싱

만약 마스터가 몇분만 기다렸다면, 사라진 샤드들은 노드 5번에 최소한의 네트워크 트래픽만 사용하고 재할당 될 수 있었을 것이다. 이 과정은 유휴 샤드라면 (인덱싱 요청을 받지 않는 샤드) 자동으로 sync-flushed 되면서 더 빠르게 진행된다.

노드가 제외되면서 미할당(unassigned) 상태가 된 레플리카 샤드의 할당 작업은 기본값이 1m인 index.unassigned.node_left.delayed_timeout 값을 설정함으로써 지연시킬 수 있다.

```bash
PUT _all/_settings
{
    "settings": {
        "index.unassigned.node_left.delayed_timeout": "5m"
    }
}
```

할당 지연 설정이 된 상태라면, 위의 시나리오는 다음과 같아진다.

- 노드 5번의 네트워크 연결이 끊김
- 마스터가 노드 5번이 가지고 있던 프라이머리 샤드에 대해 모든 레플리카 샤드를 프라이머리 샤드로 승격시킴
- 마스터가 미할당 상태인 샤드가 지연되었으며 얼마나 지연되었는지 로그로 기록함
- 미할당된 레플리카 샤드가 있기 때문에 클러스터의 상태는 yellow로 남아있음
- 노드 5번이 설정한 timeout이 지나기 전에 정상으로 돌아옴
- 사라진 레플리카들은 노드 5번에 재할당됨 (sync-flushed 된 샤드는 거의 즉시 복구됨)

> 이 설정은 레플리카를 프라이머리로 승격시키는 것과 이전에 할당되지 않은 레플리카를 할당하는 것에는 영향을 주지 않는다. 특히 클러스터 재시작 이후에는 지연된 할당이 적용되지 않는다. 또한 마스터가 failover된 경우에는 지연시간이 초기화된다.
> 

### Shard allocation 취소

지연된 할당 시간이 지나게 되면 복구 작업의 시작으로 마스터가 사라진 샤드를 다른 노드에 할당하게 된다. 사라진 노드가 클러스터에 다시 합류하게 되었고, 해당 노드의 샤드가 프라이머리의 sync-id를 계속 가지고 있다면, 샤드 할당은 취소되고 synced shard는 복구를 위해 사용된다.

이렇게 때문에 기본 timeout 값이 1분으로 설정되어 있는 것이다. 샤드 할당이 시작되더라도, 동기화된 샤드의 복구를 취소하는 것이 싸다.

### 지연된 미할당 샤드 모니터링하기

위의 설정 값을 통해 샤드 할당이 지연된 샤드의 개수를 cluster health API를 통해서 확인할 수 있다.

```bash
GET _cluster/health
```

이 응답의 delayed_unassigned_shards 값을 확인하면 된다.

### 노드 영구적으로 제외시키기

노드가 정상으로 돌아오지 않고 엘라스틱서치가 사라진 샤드를 즉시 할당하기를 원한다면, 타임아웃 값을 0으로 설정하면 된다.

```bash
PUT _all/_settings
{
    "settings": {
        "index.unassigned.node_left.delayed_timeout": "0"
    }
}
```

사라진 샤드가 복구를 시작하자마자 타임아웃 설정을 재설정 할 수 있다.